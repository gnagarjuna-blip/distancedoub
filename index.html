<script>
    const redNumbers = [1, 3, 5, 7, 9, 12, 14, 16, 18, 19, 21, 23, 25, 27, 30, 32, 34, 36];
    // European Roulette Wheel Sequence
    const wheel = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
    
    let spins = [];
    let lastPredictionsDS = {}; 
    let stats = {
        "Only (-)": { hits: 0, total: 0, streak: 0, peak: 0 },
        "Only (- & -1)": { hits: 0, total: 0, streak: 0, peak: 0 },
        "Only (- & +1)": { hits: 0, total: 0, streak: 0, peak: 0 },
        "Only (+)": { hits: 0, total: 0, streak: 0, peak: 0 },
        "Clockwise Dist": { hits: 0, total: 0, streak: 0, peak: 0 },
        "Anti-Clock Dist": { hits: 0, total: 0, streak: 0, peak: 0 }
    };

    const terminalMap = {
        1:[8], 2:[7,9], 3:[8], 4:[11], 5:[10,12], 6:[11], 7:[2,9], 8:[1,3,13,15], 9:[2,14], 10:[5,17],
        11:[4,6,16,18], 12:[5,17], 13:[8,20], 14:[7,9,19,21], 15:[8,20], 16:[11,23], 17:[10,12,22,24],
        18:[11,23], 19:[14,26], 20:[13,15,25,27], 21:[14,26], 22:[17,29], 23:[16,18,28,30], 24:[17,29],
        25:[20,32], 26:[19,21,31,33], 27:[20,32], 28:[23,35], 29:[22,24,34,36], 30:[23,35], 31:[26],
        32:[25,27], 33:[26], 34:[29], 35:[28,30], 36:[29]
    };

    // Initialize Buttons
    const panel = document.getElementById('numberPanel');
    for (let i = 1; i <= 36; i++) {
        const btn = document.createElement('button');
        btn.innerText = i;
        btn.className = `num-btn ${redNumbers.includes(i) ? 'btn-red' : 'btn-black'}`;
        btn.onclick = () => handleSpin(i);
        panel.appendChild(btn);
    }

    function getDS(num) { 
        if (num <= 0 || num > 36) return 0;
        return Math.ceil(num / 6); 
    }

    function resetSession() {
        spins = [];
        lastPredictionsDS = {};
        for(let key in stats) stats[key] = { hits: 0, total: 0, streak: 0, peak: 0 };
        document.getElementById('history').innerText = "Session Reset. Click a number...";
        document.getElementById('patternSource').innerText = "Last Hit Pattern: Waiting...";
        document.getElementById('predictionGrid').innerHTML = '';
    }

    function handleSpin(val) {
        const currentDS = getDS(val);
        let winningOps = [];

        if (Object.keys(lastPredictionsDS).length > 0) {
            for (let opName in lastPredictionsDS) {
                if(!stats[opName]) continue;
                stats[opName].total++;
                if (lastPredictionsDS[opName].includes(currentDS)) {
                    stats[opName].hits++;
                    stats[opName].streak++;
                    if (stats[opName].streak > stats[opName].peak) stats[opName].peak = stats[opName].streak;
                    winningOps.push(opName);
                } else {
                    stats[opName].streak = 0;
                }
            }
        }

        const sourceBox = document.getElementById('patternSource');
        if (winningOps.length > 0) {
            sourceBox.innerText = `Last Hit (${val}): From ${winningOps.join(' & ')} | DS Group: ${currentDS}`;
            sourceBox.style.background = "#e8f5e9";
        } else {
            sourceBox.innerText = `Last Hit (${val}): No Match`;
            sourceBox.style.background = "#ffebee";
        }

        spins.push(val);
        updateUI(currentDS, winningOps);
    }

    function updateUI(currentDS, winningOps) {
        document.getElementById('history').innerText = "History: " + spins.slice(-12).join(" | ");
        const grid = document.getElementById('predictionGrid');
        grid.innerHTML = '';

        if (spins.length < 2) return;
        
        const last = spins[spins.length - 1];
        const prev = spins[spins.length - 2];

        // Wheel Distance Logic
        const lastIdx = wheel.indexOf(last);
        const prevIdx = wheel.indexOf(prev);
        
        // Clockwise distance (forward)
        let cwDist = (lastIdx - prevIdx + 37) % 37;
        // Anti-clockwise distance (backward)
        let acwDist = (prevIdx - lastIdx + 37) % 37;

        const ops = [
            { name: "Only (-)", res: Math.abs(last - prev) },
            { name: "Only (+)", res: (last + prev) % 37 },
            { name: "Clockwise Dist", res: cwDist },
            { name: "Anti-Clock Dist", res: acwDist },
            { name: "Only (- & -1)", res: Math.abs(last - prev) - 1 },
            { name: "Only (- & +1)", res: Math.abs(last - prev) + 1 }
        ];

        let nextPredictionsDS = {};

        ops.forEach(op => {
            let deltaNum = op.res;
            // Ensure delta is within 1-36 for DS calculation
            if (deltaNum > 36) deltaNum = deltaNum % 36;
            if (deltaNum === 0) deltaNum = 37; // Avoid 0 for terminal map

            const terminals = terminalMap[deltaNum] || [];
            const targetDS = [...new Set([deltaNum, ...terminals].map(n => getDS(n)))].filter(d => d > 0 && d <= 6);
            
            nextPredictionsDS[op.name] = targetDS;

            const opStats = stats[op.name];
            const isWinner = winningOps.includes(op.name);

            const card = document.createElement('div');
            card.className = `card ${opStats.streak > 0 ? 'streak-active' : ''} ${isWinner ? 'zone-hit' : ''}`;
            
            card.innerHTML = `
                <div class="streak-badge">STREAK: ${opStats.streak}</div>
                <div class="peak-badge">PEAK: ${opStats.peak}</div>
                <strong>${op.name}</strong>
                <p style="font-size: 0.8em; color: #7f8c8d;">Distance/Value: ${op.res}</p>
                <div>
                    ${targetDS.map(ds => `<span class="ds-badge ${isWinner && ds === currentDS ? 'active-ds' : ''}">DS ${ds}</span>`).join('')}
                </div>
            `;
            grid.appendChild(card);
        });
        lastPredictionsDS = nextPredictionsDS;
    }
</script>
